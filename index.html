<!doctype html>
<html>
    <head>
        <title>Ben Wilson // Tumblr Code Test</title>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet"> 
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/simplex/bootstrap.min.css">
        <link href='http://fonts.googleapis.com/css?family=Bangers' rel='stylesheet' type='text/css'>
        <style type="text/css">
            body>header { margin: 1em 0 } 
            body>header h1 { font-family: "Bangers"; font-size: 6em }
            body>header h3 { margin-top: -.75em }
            img.ben { display: inline-block } 
            #brief p { font-size: 1.25em }
            section { margin-bottom: 1em } 
            .progress { height: 5px } 
            .posts h2 {
                max-height: 3.25em;
                overflow: hidden;
            }
            .pagination>li>a {
                width: 3em;
                text-align:center;
            }
            .pagination>.active>a, .pagination>.active>span, .pagination>.active>a:hover, .pagination>.active>span:hover, .pagination>.active>a:focus, .pagination>.active>span:focus {
                border-color: #d9230f;
            }

            input[type=text].loading {
                background: transparent url(loading.gif) 90% 50% no-repeat;
            }
        </style>
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <script src="respond.min.js"></script>
        <![endif]-->
    </head>
    <body>

        <header>
            <div class="container"> 
                <div class="row">
                    <div class="col-md-8 col-md-offset-2 text-center">
                        <h1>Ben Wilson</h1>
                        <h3>designer and developer of interactive things</h3>
                        <h2 class="text-center">Tumblr Code Test</h2>
                        <p>My Javascript solution (<a href="https://github.com/mynameiswilson/tumblr-js">github</a>)</p>
                        <p><a href="/codetest/">&laquo; back</a></p>
                    </div>
                </div>
            </div>
        </header>
        <section id="codetest">
            <div class="container">
                <div class="row">
                    <div class="col-md-8 col-md-offset-2">
                        <div class="row">
                        <form id="tumblr_form" class="col-md-6 col-md-offset-3" role="form">
                            <div class="form-group" id="tumblr_name_group">
                                <label class="sr-only" for="tumblr_name">Tumblr blog</label>
                                <input type="text" class="form-control input-lg text-center" id="tumblr_name" placeholder="Enter the name of a tumblr blog" />
                                <span class="help-block text-center">e.g. oldloves, oldloves.tumblr.com, www.worstroom.com</span>
                            </div>
                        </form>
                    </div>

                        <div id="tumblr_content" style="display:none">
                            <a href="/codetest">&laquo; start over</a>
                            <h1 class="tumblr_title"></h1>
                            <h2 class="tumblr_description"></h2>
                            <p>This <strong>tumblr</strong> was last updated <span class="last-updated"></span> and has <span class="num-posts"></span> posts, shown here <span class="per-page"></span> posts at a time on <span class="total-pages"></span> pages.<p>

                            <div class="posts_container">
                                <ul class="pagination"></ul>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width:10%"></div>
                                </div>
                                <div class="posts row"></div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width:10%"></div>
                                </div>
                                <ul class="pagination"></ul>
                            </div> 
                        </div>


                    </div>
                </div>
            </div><!--/cont-->
        </section>
        <section id="contact">
            <div class="container">
                <div class="row">
                    <div class="col-md-8 col-md-offset-2">

                        <h2 class="text-center">Contact</h2>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <p><i class="icon-envelope-alt icon-2x"></i></p>
                                <p><a href="mailto:ben@thelocust.org">ben@thelocust.org</a></p>
                                <p><i class="icon-phone icon-2x"></i></p>
                                <p><a href="tel:15028368551">1.502.836.8551</a></p>
                            </div>
                            <div class="col-md-4 text-center">
                                <p><i class="icon-twitter icon-2x"></i></p>
                                <p><a href="https://twitter.com/power_ben">@Power_Ben</a> // <strong>Work</strong></p>
                                <p><a href="https://twitter.com/mynameiswilson">@mynameiswilson</a> // <strong>Personal</strong></p>
                                <p><a href="https://twitter.com/velolouisville">@velolouisville</a> // <strong>Bikes</strong></p>
                                <p><i class="icon-stackexchange icon-2x"></i></p>
                                <p><a href="http://stackoverflow.com/users/67457/ben">My StackOverflow profile</a></p>
                            </div>

                            <div class="col-md-4 text-center">
                                <p><i class="icon-home icon-2x"></i></p>
                                <p>25 Chamberry Circle<br/>Louisville, Kentucky 40207, USA</p>
                            </div>
                        </div>
                        <p class="text-center">
                            <i class="icon-4x icon-html5"></i>
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script type="text/javascript">

            (function($) {
                /* http://stackoverflow.com/a/1038930/67457 */
                String.prototype.format = String.prototype.f = function() {
                    var s = this,
                    i = arguments.length;

                    while (i--) {
                    s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
                    }
                    return s;
                    };

                function getDomainFromURI(uri) {
                    var tmp = document.createElement('a');
                    tmp.href = uri;
                    return tmp.hostname;
                }

                function _hash_change() {
                    if (window.location.hash != "") {
                        hash = window.location.hash.substr(1);
                        if (hash.indexOf("|")!=-1) {
                            hash_array = hash.split("|");
                            name = hash_array[0];
                            cur_page = parseInt(hash_array[1]);
                        } else {
                            name = hash;
                            cur_page = 1;
                        }

                        do_tumblr_search(name,cur_page);
                    }
                        //    $("#tumblr_name").val("");
                }
                function _tumblr_name_change() {
                    do_tumblr_search($('#tumblr_name').val(),1);
                }
                
                function on_search_success(tumblr_data) {
                    //TumblrDisplay
                    var display = new TumblrDisplay(tumblr_data,{ 
                        container: ".posts_container",
                        posts_container: ".posts_container .posts",
                        pagination_container: ".posts_container .pagination",
                        current_page: search.current_page
                        });

                };
                var search = new TumblrSearch({
                    on_search_success: on_search_success
                });
                
                function do_tumblr_search(name,page) {
                    console.log("firing tumblr search for " + name + ", page #" + page);
                    search.search(name,page);
                }

                $(document).ready(function() {
                    console.log('ready');
                    var keyup_timeout;
                    $(window).on("hashchange", _hash_change);
                    $('#tumblr_form').on("submit",function() { return false; });
                    $('#tumblr_name').on("keyup",function(){ clearTimeout(keyup_timeout); keyup_timeout = setTimeout(_tumblr_name_change,1000); })
                    .on("change",_tumblr_name_change);

                    _hash_change();
                });
             
                /* TumblrSearch */
                function TumblrSearch(opts) {
                    this.tumblr_api_url = 'http://api.tumblr.com/v2/blog/{0}/posts?api_key={1}&limit={2}&offset={3}&filter=text&jsonp=?',
                    this.current_page = 1;
                    this.settings = {
                        form_group: '#tumblr_form .form-group', 
                        per_page: 10,
                        on_search: function() { $('#tumblr_name').addClass("loading"); },
                        on_search_end: function() { $('#tumblr_name').removeClass("loading"); },
                        on_search_success: function() { console.log("SUCCESS"); },
                        tumblr_api_key: 'fuiKNFp9vQFvjLNvx4sUwti4Yb5yGutBN4Xh10LXZhhRKjWlV4'
                    };

                    $.extend(this.settings,opts);

                    //todo make this required
                    if(this.settings.hasOwnProperty('tumblr_api_key')) {
                        this.tumblr_api_key = this.settings.api_key;
                    } else {
                        throw 'No Tumblr api key provided.';
                    }

                };

                TumblrSearch.prototype.showMsg = function(msg,type) {
                    console.log(type + ": " + msg); // todo genericise
                    $(this.settings.form_group).removeClass('has-error has-success');
                    $(this.settings.form_group).addClass( (type=="error") ? 'has-error':'has-success' );
                    $(this.settings.form_group + ' .help-block').html(msg);
                };

                TumblrSearch.prototype.search = function(name,page) {
                    var me = this;
                    this.current_page = page;

                    if (typeof this.settings.on_search == "function") this.settings.on_search();
                    if (this.name = this.validateName(name)) {

                        var url = this.tumblr_api_url.f(this.name,this.settings.tumblr_api_key,this.settings.per_page,(this.current_page-1)*this.settings.per_page);
                        var req = $.ajax({
                                    url : url,
                                    dataType : "jsonp",
                                    timeout : 10000,
                                    success : function(data,status) { 
                                        if (typeof me.settings.on_search_end == "function") me.settings.on_search_end();
                                        me._handle_tumblr_req(data,status); 
                                    },
                                    error : function() { console.log("FAIL!"); } 
                                    });
                    } else {
                        this.showMsg("not a valid tumblr name","error");
                    }
                };

                TumblrSearch.prototype.validateName = function(name) {

                    var match = name.match(/^[a-zA-Z\d]+(\.tumblr\.com)?$|^(?:[-A-Za-z0-9]+\.)+[A-Za-z]{2,6}/ );
                    if (match != null) {
                        console.log(name + " is a valid tumblr name");
                        return match[0] + ((match[0].indexOf(".")==-1)?".tumblr.com":"");
                    } else { 
                        
                        console.log(name + " is NOT a valid tumblr name");
                        return false;
                    }
                };

                TumblrSearch.prototype._handle_tumblr_req = function(data,status) {
                    var me = this;

                    if (data.hasOwnProperty("meta") && data.meta.hasOwnProperty("status") && data.meta.status == 404) {
                        //alert user to failboat
                        $('#tumblr_content').hide();
                        this.showMsg("tumblr blog not found!","error");

                    } else {
                        
                        // set input textbox to validated tumblr name
                        if (data.response.hasOwnProperty("blog") && data.response.blog.hasOwnProperty("url")) {
                            //sneaky pete!

                            $('#tumblr_name').val(getDomainFromURI(data.response.blog.url));
                        }

                        $('#tumblr_name').blur();
                        //alert user to success
                        this.showMsg("found it!","success");

                        if (data.hasOwnProperty("meta") && data.meta.hasOwnProperty("status") && data.meta.status == 200 ) {
                            if (data.hasOwnProperty("response")) {

                                this.data = data.response;
                                var display = new TumblrDisplay(this, {
                                        container: ".posts_container",
                                        posts_container: ".posts_container .posts",
                                        pagination_container: ".posts_container .pagination",
                                        current_page: me.current_page
                                        });
//                                this.settings.on_search_success(data.response);
                            } else {
                                console.log('did not get response');
                            }
                        }
                    }

                };

                /* Tumblr Display */
                function TumblrDisplay(search,opts) {
                    var me = this;
                    this.search = search;
                    this.current_page = search.current_page;
                    this.settings = {
                        container: "#tumblr_content",
                        pagination_container: ".pagination",
                        posts_container: ".posts",
                        sel_title: '#tumblr_content .tumblr_title',
                        sel_description: "#tumblr_content .tumblr_description",
                        sel_last_updated: "#tumblr_content .last-updated",
                        sel_num_posts: "#tumblr_content .num-posts",
                        sel_per_page: "#tumblr_content .per-page",
                        sel_total_pages: "#tumblr_content .total-pages",
                        pagination_tick: '<li class="{0}"><a data-page={1} href="#">{1}</a></li>',
                        post_template: '<div class="col-md-{3}"><h2><a href="{0}">{1}</a></h2><p class="date">{2}</p></div>',
                        posts_per_page: 10,
                        current_page: 1
                    };
                    $.extend(this.settings,opts);

                    this.total_pages = Math.ceil(this.search.data.blog.posts/this.settings.posts_per_page);

                    this.pagination = new Pagination(this, { 
                        pagination_container: ".pagination", 
                        page_changed: function(page) {
                            me.search.current_page = page;
                            window.location.hash = "#" + getDomainFromURI(me.search.data.blog.url)  + "|" + me.search.current_page;
                        }
                    });

                    

                    //The locs property is required
                    if(this.search.data.hasOwnProperty("posts")) {
                        $('#tumblr_content').show();
                        this.data = this.search.data;
                        this.displayMeta();
                        this.displayPosts();
                    } else {
                        throw 'No Tumblr data provided.';
                    }
                };

                TumblrDisplay.prototype.displayMeta = function() {
                    $(this.settings.sel_title).html(this.data.blog.title);
                    $(this.settings.sel_description).html(this.data.blog.description);
                    $(this.settings.sel_num_posts).html(this.data.blog.posts); 
                    var last_updated = new Date(this.data.blog.updated * 1000);
                    $(this.settings.sel_last_updated).html(last_updated); 
                    $(this.settings.sel_per_page).html(this.settings.posts_per_page);
                    $(this.settings.sel_total_pages).html(this.total_pages);

                }

                TumblrDisplay.prototype.displayPosts = function() {
                    $posts = $(this.settings.posts_container).html("");
                    for (var i=0;i<this.data.posts.length;i++) {
                        post = this.data.posts[i];
                        $posts.append( this.settings.post_template.f( post.post_url,(typeof post.caption == "undefined")?"<em>untitled</em>":post.caption,post.date, (i==0)?"12":"4" ) );
                        if ( i==0 || i%3==0 ) {
                            $posts.append('</div><!--/end row-->\n<div class="row">');
                        }
                    }

                }


                var Pagination = function(display,opts) {
                    var me = this;
                    if (display.hasOwnProperty("total_pages") != "undefined") {
                        this.total_pages = parseInt(display.total_pages);
                        this.settings = {
                            pages_to_show_in_nav: 11,
                            pagination_container: ".pagination",
                            pagination_tick: '<li class="{0}"><a data-page={1} href="#">{1}</a></li>',
                            page_changed: function(page) {}
                        };
                        $.extend(this.settings,opts);

                        if (display.hasOwnProperty("current_page")) {
                            this.current_page = display.current_page;
                        }

                        $(this.settings.pagination_container).on("click","a",function() { 
                                event.preventDefault();
                                if ( $(this).parent().hasClass("prev") ) to_page = me.current_page - 1;
                                if ( $(this).parent().hasClass("rwd") )  to_page = me.current_page - 10;
                                if ( $(this).parent().hasClass("ffwd") ) to_page = me.current_page + 10;
                                if ( $(this).parent().hasClass("next") ) to_page = me.current_page + 1;
                                if ( $(this).parent().hasClass("page") ) to_page = $(this).data("page");
                                me.goPage(to_page) 
                        });

                        this.draw();
                    } 
                };
                Pagination.prototype.draw = function() {
                    var start_page = 1;
                    var $pager = $(this.settings.pagination_container)
                        .html("")
                        .append( this.settings.pagination_tick.f( "prev "+((this.current_page==1)?"disabled":""),"&laquo;") )
                        .append( this.settings.pagination_tick.f( "rwd "+((this.current_page==1)?"disabled":""),"&laquo;&laquo;") );

                    if ( this.total_pages < this.settings.pages_to_show_in_nav ) 
                        pages_to_show_in_nav = total_pages;

                    if (this.current_page >= this.settings.pages_to_show_in_nav/2) {
                        start_page = this.current_page+1-Math.ceil( this.settings.pages_to_show_in_nav/2);
                     
                    }
                    if (start_page + this.settings.pages_to_show_in_nav > this.total_pages) {
                        start_page = this.total_pages - this.settings.pages_to_show_in_nav + 1;
                    }

                    for (var i=start_page;i<start_page+ this.settings.pages_to_show_in_nav;i++) {
                        $pager.append( this.settings.pagination_tick.f( "page " + ((this.current_page==i)?"active":"") ,i) );
                    }

                    $pager.append( this.settings.pagination_tick.f("ffwd "+((this.current_page==this.total_pages)?"disabled":""),"&raquo;&raquo;") )
                          .append( this.settings.pagination_tick.f("next "+((this.current_page==this.total_pages)?"disabled":""),"&raquo;") );

                };
                Pagination.prototype.goPage = function(page) {
                   console.log('going to page ' + page); 
                    if (page <= 0) page = 1;
                    if (page > this.total_pages) page = this.total_pages;

                    if ( page > 0 && page <= this.total_pages  ) {
                        this.current_page = page;
                        //callback
                        this.settings.page_changed(this.current_page);
                    }

                };

            })(jQuery);


        </script>
        <script type="text/javascript">

            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-82128-4']);
            _gaq.push(['_trackPageview']);

            (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();

        </script>
    </body>
</html>
